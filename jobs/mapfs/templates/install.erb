#!/bin/bash
<% if p("disable") %>
<% else %>
set -eo pipefail

function prepend_rfc3339_datetime() {
  perl -ne 'BEGIN { use Time::HiRes "time"; use POSIX "strftime"; STDOUT->autoflush(1) }; my $t = time; my $fsec = sprintf ".%09d", ($t-int($t))*1000000000; my $time = strftime("[%Y-%m-%dT%H:%M:%S".$fsec."Z]", localtime $t); print("$time $_")'
}

function main() {

  if [[ ! -f /sbin/mount.fuse3 ]]; then
    echo "symlinking fuse mounthelper binary to /sbin"
    ln -s /var/vcap/packages/mapfs-fuse/sbin/mount.fuse3 /sbin/mount.fuse3
  fi

  if [[ ! -f /bin/fusermount ]]; then
    echo "symlinking fusermount3 to /bin/fusermount"
    ln -s /var/vcap/packages/mapfs-fuse/bin/fusermount3 /bin/fusermount
  fi

  for f in $( find /var/vcap/packages/mapfs-fuse/lib/x86_64-linux-gnu/ -name  "*.so*" ); do 
    FILENAME=$(basename $f)
    if [[ ! -f /lib/${FILENAME} ]]; then
      echo "symlinking shared lib ${FILENAME} to /lib"
      ln -s $f /lib/${FILENAME}
    fi
  done

  modprobe fuse || true
  groupadd fuse || true
  adduser vcap fuse
  chown root:fuse /dev/fuse
cat << EOF > /etc/fuse.conf
user_allow_other
EOF
  chmod 644 /etc/fuse.conf

  echo "Installing mapfs"

  chown root:vcap /var/vcap/packages/mapfs/bin/mapfs
  chmod 750 /var/vcap/packages/mapfs/bin/mapfs
  chmod u+s /var/vcap/packages/mapfs/bin/mapfs
}

main | prepend_rfc3339_datetime
<% end %>
